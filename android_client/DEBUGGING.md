# Инструкция по отладке проблем с уведомлениями

## Проблема 1: Уведомления не приходят

### Проверка на сервере:

1. **Проверьте логи сервера** при отправке тестового уведомления:
   ```bash
   # В логах должно быть:
   # "Клиент {client_id} подключен"
   # "Уведомление о нарушении {violation_id} отправлено через event loop приложения"
   ```

2. **Проверьте подключенных клиентов**:
   - Откройте в браузере: `http://<SERVER_IP>:8000/api/notifications/clients`
   - Должен быть список подключенных клиентов с вашим client_id

3. **Проверьте отправку тестового уведомления**:
   - Откройте в браузере: `http://<SERVER_IP>:8000/api/notifications/test` (POST)
   - В ответе должно быть: `{"message": "Тестовое уведомление отправлено", "sent_to": [...]}`

### Проверка на Android-клиенте:

1. **Проверьте логи Android-приложения** (Logcat):
   ```bash
   adb logcat | grep -i "websocket\|notification\|violation"
   ```
   
   Должны быть логи:
   - `WebSocketClient: Received message: ...`
   - `WebSocketClient: Processing violation notification`
   - `MainActivity: Received notification: violationId=...`

2. **Проверьте статус WebSocket соединения**:
   - Откройте настройки в приложении
   - Статус должен быть "Подключено"

3. **Проверьте, что нарушение сохраняется в БД**:
   - Откройте историю нарушений
   - Должно появиться новое нарушение

## Проблема 2: Разлогинивание при блокировке экрана

### Решение:

1. **Foreground Service** - уже реализован
   - При подключении запускается `WebSocketService`
   - Service поддерживает соединение в фоне
   - Использует WakeLock для предотвращения засыпания

2. **Проверка работы**:
   - Подключитесь к серверу
   - Заблокируйте экран
   - Подождите 1-2 минуты
   - Разблокируйте экран
   - Проверьте статус подключения - должно быть "Подключено"

3. **Если проблема сохраняется**:
   - Проверьте настройки батареи на устройстве
   - Отключите оптимизацию батареи для приложения
   - Проверьте, что Foreground Service не убивается системой

## Дополнительные проверки:

### Проверка парсинга уведомлений:

В логах Android должно быть:
```
WebSocketClient: Received message: {"type":"violation","violation_id":"...",...}
WebSocketClient: Processing violation notification
WebSocketClient: Notification parsed: violationId=..., zoneName=...
MainActivity: Received notification: violationId=..., zoneName=...
MainViewModel: Saving violation from notification: ...
```

### Проверка сохранения в БД:

После получения уведомления проверьте:
- История нарушений обновилась
- Нарушение видно в списке
- При открытии деталей показывается изображение

### Проверка открытия экрана деталей:

При получении уведомления:
- Должен автоматически открыться экран `ViolationDetailActivity`
- Должны отображаться кнопки "Подтвердить" и "Ложное срабатывание"
- Должно загружаться изображение нарушения

## Частые проблемы:

1. **WebSocket не подключается**:
   - Проверьте IP-адрес и порт сервера
   - Проверьте, что сервер запущен
   - Проверьте, что устройство в той же сети

2. **Уведомления не приходят**:
   - Проверьте, что клиент зарегистрирован на сервере
   - Проверьте логи сервера на наличие ошибок
   - Проверьте логи Android на наличие ошибок парсинга

3. **Изображение не загружается**:
   - Проверьте, что imagePath правильный
   - Проверьте, что сервер доступен
   - Проверьте логи Glide на наличие ошибок

